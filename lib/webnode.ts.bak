export async function fetchWebnode(url: string) {
  const headers: Record<string, string> = {
    "user-agent":
      "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0 Safari/537.36",
    "accept":
      "text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8",
    "accept-language": "cs-CZ,cs;q=0.9,en;q=0.8",
    "cache-control": "no-cache",
    "pragma": "no-cache",
    "referer": url
  }

  async function tryFetch(target: string) {
    const res = await fetch(target, {
      headers,
      redirect: "follow",
      cache: "no-store",
      // @ts-ignore (Next runtime)
      next: { revalidate: 0 }
    })
    if (!res.ok) {
      throw new Error(`HTTP ${res.status} ${res.statusText}`)
    }
    let html = await res.text()

    // Odstraň <script> a inline on* handlery
    html = html.replace(/<script[\s\S]*?<\/script>/gi, "")
    html = html.replace(/ on\w+="[^"]*"/gi, "").replace(/ on\w+='[^']*'/gi, "")

    // Ponech iframes pouze pro YouTube/Vimeo
    html = html.replace(/<iframe(?![^>]*(youtube|vimeo)).*?<\/iframe>/gi, "")

    // Absolutizace href/src/url(...)
    const absolutize = (m: string, q: string, u: string) => {
      try { return `${m.split(q+u)[0]}${q}${new URL(u, target).toString()}${q}` } catch { return m }
    }
    html = html.replace(/href=(")(.*?)\1/gi, (m, q, u) => absolutize(m, q, u))
    html = html.replace(/src=(")(.*?)\1/gi,  (m, q, u) => absolutize(m, q, u))
    html = html.replace(/url\((["'])(.*?)\1\)/gi, (m, q, u) => {
      try { return `url(${q}${new URL(u, target).toString()}${q})` } catch { return m }
    })

    // Schovat cookie bar
    html = html.replace(/<div[^>]*cookie[^>]*>[\s\S]*?<\/div>/gi, "")
    return html
  }

  try {
    return await tryFetch(url)
  } catch (e1: any) {
    // krátké zpoždění a 2. pokus (někdy Webnode občas vrátí 403/500)
    await new Promise(r => setTimeout(r, 500))
    try {
      return await tryFetch(url)
    } catch (e2: any) {
      // předáme text chyby ven – uvidíš ho v UI
      throw new Error(e2?.message || e1?.message || "Fetch failed")
    }
  }
}
